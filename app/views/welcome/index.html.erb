
<% if current_user.employee? %>
<div class="container">
  <div class="row">
    <div class="col-xs-12" style="padding-bottom:5px;">
      <div id="map" class="col-xs-12" style='height: 400px; text-align:center;'></div>
    </div>
    
    <script type="text/javascript">
        handler = Gmaps.build('Google');
        handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
          //markers = handler.addMarkers(<%=raw @hash.to_json %>);
          markers = handler.addMarkers(<%=raw @hash2.to_json %>);
          handler.bounds.extendWith(markers);
          handler.fitMapToBounds();
        });
        
    // 現在地取得処理
    function initMap() {
      // Geolocation APIに対応している
      if (navigator.geolocation) {
        // 現在地を取得
        navigator.geolocation.getCurrentPosition(
          // 取得成功した場合
          function(position) {
            // 緯度・経度を変数に格納
            var mapLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            /*
            // マップオプションを変数に格納
            var mapOptions = {
              zoom : 15,          // 拡大倍率
              center : mapLatLng  // 緯度・経度
            };
            // マップオブジェクト作成
            var map = new google.maps.Map(
              document.getElementById("map"), // マップを表示する要素
              mapOptions         // マップオプション
            );
            //　マップにマーカーを表示する
            var marker = new google.maps.Marker({
              map : map,             // 対象の地図オブジェクト
              position : mapLatLng   // 緯度・経度
            });
            alert(mapLatLng);
            */
            // Hayashida
            jQuery('#latitude').val(position.coords.latitude);
            jQuery('#longitude').val(position.coords.longitude);
            //alert(position.coords.latitude + ', ' + position.coords.longitude);
          },
          // 取得失敗した場合
          function(error) {
            // エラーメッセージを表示
            switch(error.code) {
              case 1: // PERMISSION_DENIED
                alert("位置情報の利用が許可されていません");
                break;
              case 2: // POSITION_UNAVAILABLE
                alert("現在位置が取得できませんでした");
                break;
              case 3: // TIMEOUT
                alert("タイムアウトになりました");
                break;
              default:
                alert("その他のエラー(エラーコード:"+error.code+")");
                break;
            }
          }
        );
      // Geolocation APIに対応していない
      } else {
        alert("この端末では位置情報が取得できません");
      }
    }
    
      function initMap2() {
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 12,
          center: {lat: 40.742966, lng: -74.006865},
          mapTypeId: 'terrain'
        });

        // var flightPlanCoordinates = [
        //   {lat: 37.772, lng: -122.214},
        //   {lat: 21.291, lng: -157.821},
        //   {lat: -18.142, lng: 178.431},
        //   {lat: -27.467, lng: 153.027}
        // ];
        var flightPlanCoordinates = [
          <% Activity.all.each do |activity| %>
            <% if activity.schedule_latitude && activity.schedule_longitude %>
              <%= "{lat: " + activity.schedule_latitude.to_s + ", lng: " + activity.schedule_longitude.to_s + "}," %>
            <% end %>
          <% end %>
        ];
        var flightPath = new google.maps.Polyline({
          path: flightPlanCoordinates,
          geodesic: true,
          strokeColor: '#FF0000',
          strokeOpacity: 1.0,
          strokeWeight: 2
        });

        flightPath.setMap(map);

        var image='<%=image_path('clock.png')%>';
        // var marker1=new google.maps.Marker({
        //     position: new google.maps.LatLng(40.742966, -74.006865),
        //     map: map,
        //     icon: image
        // });
        // var infowindow1=new google.maps.InfoWindow({
        //     content: "<b>Test</b><h2>Hey!</h2>",
        //     maxWidth:200
        // });
        // google.maps.event.addListener(marker1, 'click', function() {
        //     infowindow1.open(map,marker1);
        // });
        
        <% Activity.all.each do |activity| %>
          <% if activity.schedule_latitude && activity.schedule_longitude %>
              var marker<%=activity.id%> = new google.maps.Marker({
                  position: new google.maps.LatLng(<%=activity.schedule_latitude%>, <%=activity.schedule_longitude%>),
                  map: map,
                  icon: image
              });
              var infowindow<%=activity.id%> = new google.maps.InfoWindow({
                  content: "<h4><%=activity.schedule_place_name%></h4><p><%=activity.schedule_datetime.try(:strftime, "%Y-%m-%d %l:%M:%S %p")%></p>",
                  maxWidth: 200
              });
              google.maps.event.addListener(marker<%=activity.id%>, 'click', function() {
                  infowindow<%=activity.id%>.open(map,marker<%=activity.id%>);
              });
          <% end %>
        <% end %>
      }
    //initMap();
    initMap2();
    </script>
  </div>
  <div class="row">
    <%= form_tag update_current_location_path, method: :update, class: 'form-horizontal' do %>
      <div class="form-group">
        <%= hidden_field_tag :latitude, value: '' %>
        <%= hidden_field_tag :longitude, value: '' %>
        <div class="col-xs-offset-2 col-xs-2"><%= button_tag(type: :submit, class: "btn btn-sm btn-success") do %>Check-in<% end %></div>
      </div>
    <% end %>
  </div>
<% if @today_activities %>
  <div class="row" style="padding-bottom:30px;">
    <table class="table table-bordered table-hover table-sm">
      <thead class="thead-light">
        <tr>
          <th class="col-md-1"></th>
          <th class="col-md-3">Datetime</th>
          <th class="col-md-8">Place</th>
        </tr> 
      </thead>
      <tbody>
        <% @today_activities.each do |activity| %>
        <tr>
          <td scope="row" style="text-align:center; vertical-align:middle;">
            <%= link_to "Detail", activity_path(activity), class: "btn btn-primary btn-sm" %>
          </td>
          <td><%= activity.schedule_datetime.try(:strftime, "%Y-%m-%d %l:%M:%S %p") %></td>
          <td><%= activity.schedule_place_name %></td>
        </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

  <div class="row">
    <div class="col-md-6 col-xs-12">
      <div class="panel panel-default">
        <div class="panel-heading" style="font-weight:bold;">Closed Opportunities 2018</div>
        <div class="panel-body">
          <canvas id="myChart"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-xs-12">
      <div class="panel panel-default">
        <div class="panel-heading" style="font-weight:bold;">Uncompleted Activities</div>
        <div class="panel-body">
          <canvas id="myChart2"></canvas>
        </div>
      </div>
    </div>
  </div>


  <div class="row">
    <div class="col-xs-12">
      <div class="panel panel-default">
        <div class="panel-heading" style="font-weight:bold;">Uncompleted Activities by Due Date</div>
        <div class="panel-body">
          <canvas id="myChart3"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="panel panel-default">
        <div class="panel-heading" style="font-weight:bold;">Closed Opportunities</div>
        <div class="panel-body">
          <canvas id="myChart4"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>


<script type="text/javascript">
var ctx = document.getElementById('myChart').getContext('2d');
var myChart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: ['Jan', 'Feb', 'Mar'],
    datasets: [{
      label: 'Closed Opportunity 2018',
      data: [10, 15, 12],
      backgroundColor: [
        "#2ecc71",
        "#3498db",
        "#95a5a6"
      ]
    }]
  },
  options: {
    scales: {
      yAxes: [
        {
          ticks: {
            beginAtZero: true,
            min: 0,
            max: 50
          }
        }
      ]
    }
  }
});

var ctx2 = document.getElementById('myChart2').getContext('2d');
var myChart2 = new Chart(ctx2, {
  type: 'pie',
  data: {
    labels: ['Over Due', 'Uncompleted'],
    datasets: [{
      label: 'Uncompleted Activities',
      data: [8, 20],
      backgroundColor: [
        "#e74c3c",
        "#f1c40f"
      ]
    }]
  }
});

document.getElementById( 'myChart2' ).onclick = function( evt ) {
    window.location.href = "./customer.html"
}


var ctx3 = document.getElementById('myChart3').getContext('2d');
var myChart3 = new Chart(ctx3, {
  type: 'bar',
  data: {
    labels: ['2/26','2/27','2/28','3/1','3/2','3/3','3/4','3/5','3/6','3/7','3/8','3/9','3/10','3/11','3/12','3/13','3/14','3/15','3/16','3/17','3/18','3/19','3/20','3/21','3/22','3/23','3/24','3/25','3/26','3/27','3/28','3/29','3/30','3/31'],
    datasets: [{
      label: 'Uncompleted Activities by Due Date',
      data: [3, 4, 1, 5, 3, 3, 4, 2, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      backgroundColor: [
        "#e74c3c",
        "#e74c3c",
        "#e74c3c",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6",
        "#95a5a6"
      ]
    }]
  },
  options: {
    scales: {
      yAxes: [
        {
          ticks: {
            beginAtZero: true,
            min: 0,
            max: 20
          }
        }
      ]
    }
  }
});


var ctx4 = document.getElementById('myChart4').getContext('2d');
var myChart4 = new Chart(ctx4, {
  type: 'line',
  data: {
    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
    datasets: [{
      label: '2016',
      data: [10, 20, 20, 30, 25, 30, 10, 20, 30, 40, 40, 20],
      backgroundColor: "rgba(153,255,51,0.4)"
    }, {
      label: '2017',
      data: [40, 40, 20, 30, 50, 60, 60, 60, 50, 60, 50, 70],
      backgroundColor: "rgba(255,153,0,0.4)"
    }]
  },
  options: {
    scales: {
      yAxes: [
        {
          ticks: {
            beginAtZero: true,
            min: 0,
            max: 100
          }
        }
      ]
    }
  }
});

</script>
<% end %>